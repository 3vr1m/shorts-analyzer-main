name: Deploy to Hetzner
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          port: ${{ secrets.HETZNER_SSH_PORT || 22 }}
          script: |
            set -e
            PROJECT_DIR="${{ secrets.PROJECT_DIR || '/root/shorts-analyzer' }}"
            REPO_URL="${{ secrets.REPO_URL || 'https://github.com/3vr1m/shorts-analyzer-main.git' }}"
            echo "ğŸš€ Starting deployment to $PROJECT_DIR"
            mkdir -p "$(dirname "$PROJECT_DIR")"
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "ğŸ“¦ First-time setup: cloning repository..."
              rm -rf "$PROJECT_DIR" || true
              git clone "$REPO_URL" "$PROJECT_DIR"
            fi
            cd "$PROJECT_DIR"
            echo "ğŸ“¥ Fetching latest changes..."
            git fetch origin main
            git reset --hard origin/main
            echo "ğŸ”§ Writing .env from GitHub secrets..."
            cat > .env << 'EOF'
            NEXT_PUBLIC_OPENAI_API_KEY=${{ secrets.NEXT_PUBLIC_OPENAI_API_KEY }}
            NEXT_PUBLIC_GOOGLE_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_API_KEY }}
            NEXT_PUBLIC_YOUTUBE_API_KEY=${{ secrets.NEXT_PUBLIC_YOUTUBE_API_KEY }}
            ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}
            ADMIN_SECRET=${{ secrets.ADMIN_SECRET }}
            EOF
            if docker compose version >/dev/null 2>&1; then
              DC="docker compose"
            else
              DC="docker-compose"
            fi
            echo "ğŸ›‘ Stopping existing containers..."
            $DC down || true
            echo "ğŸ§¹ Cleaning up old images..."
            docker system prune -f || true
            echo "ğŸ”¨ Building and starting containers..."
            $DC up -d --build
            echo "â³ Waiting for services to start..."
            sleep 30
            echo "ğŸ” Checking container status..."
            $DC ps
            echo "ğŸ¥ Checking application health..."
            if curl -fsS http://localhost:3000/api/health >/dev/null; then
              echo "âœ… Application is healthy!"
            else
              echo "âŒ Application health check failed! Dumping app logs..."
              $DC logs app || true
              exit 1
            fi
            echo "ğŸ‰ Deployment completed successfully!"
name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HETZNER_HOST }}
        username: ${{ secrets.HETZNER_USER }}
        key: ${{ secrets.HETZNER_SSH_KEY }}
        port: ${{ secrets.HETZNER_SSH_PORT }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment for Shorts Analyzer..."
          
          # Navigate to production directory
          cd /opt/shorts-analyzer
          
          # Pull latest code from the new GitHub repository
          git remote set-url origin https://github.com/3vr1m/shorts-analyzer-main.git
          git fetch origin main
          git reset --hard origin/main
          
          echo "ğŸ“¦ Building and deploying with Docker..."
          
          # Build and deploy with Docker
          docker compose down
          docker compose up -d --build
          
          # Clean up old images to save space
          docker image prune -f
          
          # Check if containers are running
          echo "ğŸ” Checking container status..."
          docker compose ps
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Shorts Analyzer is running on port 4001"
